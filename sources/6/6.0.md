### **Android ç³»ç»Ÿå¯åŠ¨æµç¨‹ï¼šAMS ä¸ Zygote çš„æ ¸å¿ƒä½œç”¨è§£æ**

Android ç³»ç»Ÿçš„å¯åŠ¨æµç¨‹æ¶‰åŠå¤šä¸ªå…³é”®ç»„ä»¶ï¼Œå…¶ä¸­ **ActivityManagerService (AMS)** å’Œ **Zygote** æ˜¯æ ¸å¿ƒæ¢çº½ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„åä½œæµç¨‹å’ŒåŸç†è¯¦è§£ï¼š

---

#### **ä¸€ã€æ•´ä½“å¯åŠ¨æµç¨‹æ¦‚è§ˆ**
```mermaid
sequenceDiagram
    participant Bootloader
    participant Kernel
    participant Init
    participant Zygote
    participant SystemServer
    participant AMS

    Bootloader->>Kernel: åŠ è½½Linuxå†…æ ¸
    Kernel->>Init: å¯åŠ¨initè¿›ç¨‹
    Init->>Zygote: å¯åŠ¨Zygoteè¿›ç¨‹
    Zygote->>SystemServer: fork()å‡ºSystemServer
    SystemServer->>AMS: åˆ›å»ºå¹¶æ³¨å†ŒAMS
    AMS->>Zygote: è¯·æ±‚forkåº”ç”¨è¿›ç¨‹
```

---

#### **äºŒã€Zygote çš„æ ¸å¿ƒä½œç”¨**
##### **1. Zygote çš„å¯åŠ¨**
- **init.rc è§¦å‘**ï¼šç”± init è¿›ç¨‹è§£æå¯åŠ¨è„šæœ¬ï¼ŒåŠ è½½ Zygoteï¼š
  ```bash
  # init.zygote64.rc
  service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server
      class main
      socket zygote stream 660 root system
  ```
- **å…³é”®èŒè´£**ï¼š
  - **é¢„åŠ è½½èµ„æº**ï¼šç±»ã€ä¸»é¢˜ã€å…±äº«åº“ç­‰ï¼ˆåŠ é€Ÿåç»­åº”ç”¨å¯åŠ¨ï¼‰ã€‚
  - **Socket ç›‘å¬**ï¼šé€šè¿‡ `/dev/socket/zygote` æ¥æ”¶ AMS çš„è¿›ç¨‹åˆ›å»ºè¯·æ±‚ã€‚
  - **fork æœºåˆ¶**ï¼šé‡‡ç”¨ Copy-on-Write (COW) æŠ€æœ¯å¿«é€Ÿåˆ›å»ºæ–°è¿›ç¨‹ã€‚

##### **2. Zygote çš„å·¥ä½œæµç¨‹**
```java
// ZygoteInit.java
public static void main(String[] argv) {
    // 1. é¢„åŠ è½½ç±»å’Œèµ„æº
    preload(); 
    // 2. å¯åŠ¨SystemServer
    if (argv[1].equals("--start-system-server")) {
        forkSystemServer();
    }
    // 3. è¿›å…¥å¾ªç¯ï¼Œç›‘å¬AMSè¯·æ±‚
    runSelectLoop();
}
```

---

#### **ä¸‰ã€ActivityManagerService (AMS) çš„æ ¸å¿ƒä½œç”¨**
##### **1. AMS çš„åˆ›å»º**
- **SystemServer åˆå§‹åŒ–**ï¼šç”± Zygote fork å‡ºçš„ SystemServer è¿›ç¨‹å¯åŠ¨ AMSï¼š
  ```java
  // SystemServer.java
  private void startBootstrapServices() {
      mActivityManagerService = new ActivityManagerService(context);
      ServiceManager.addService("activity", mActivityManagerService);
  }
  ```
- **ä¸»è¦åŠŸèƒ½**ï¼š
  - **åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šå¯åŠ¨ã€é”€æ¯ã€è°ƒåº¦ Activityã€‚
  - **è¿›ç¨‹ç®¡ç†**ï¼šé€šè¿‡ Zygote åˆ›å»ºåº”ç”¨è¿›ç¨‹ã€‚
  - **å››å¤§ç»„ä»¶è°ƒåº¦**ï¼šåè°ƒ Activityã€Serviceã€Broadcastã€ContentProviderã€‚

##### **2. AMS ä¸ Zygote çš„äº¤äº’**
å½“éœ€è¦å¯åŠ¨æ–°åº”ç”¨æ—¶ï¼š
1. **AMS å‘é€è¯·æ±‚**ï¼šé€šè¿‡ Socket å‘ Zygote ä¼ é€’å‚æ•°ï¼ˆå¦‚ UIDã€GIDã€ä¸»ç±»åï¼‰ã€‚
2. **Zygote fork è¿›ç¨‹**ï¼šå¤åˆ¶è‡ªèº«åˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ‰§è¡Œ `ActivityThread.main()`ã€‚
3. **è¿›ç¨‹åˆå§‹åŒ–**ï¼šæ–°è¿›ç¨‹åŠ è½½ç›®æ ‡ APK çš„ `Application` å’Œ `Activity`ã€‚

```java
// ActivityManagerService.java
void startProcess(String processName, ApplicationInfo info) {
    Process.ProcessStartResult startResult = Process.start(
        "android.app.ActivityThread", 
        info.processName,
        uid, gid, 
        // å…¶ä»–å‚æ•°...
    );
}
```

---

#### **å››ã€å…³é”®åä½œæµç¨‹ç¤ºä¾‹ï¼šå¯åŠ¨ä¸€ä¸ª App**
1. **ç”¨æˆ·ç‚¹å‡»å›¾æ ‡**ï¼šLauncher é€šè¿‡ Binder è°ƒç”¨ AMS çš„ `startActivity()`ã€‚
2. **AMS æ£€æŸ¥æƒé™**ï¼šéªŒè¯ç›®æ ‡ Activity æ˜¯å¦åœ¨ Manifest ä¸­å£°æ˜ã€‚
3. **è¯·æ±‚ Zygote**ï¼šè‹¥ç›®æ ‡è¿›ç¨‹ä¸å­˜åœ¨ï¼ŒAMS é€šè¿‡ Socket é€šçŸ¥ Zygote fork æ–°è¿›ç¨‹ã€‚
4. **è¿›ç¨‹åˆå§‹åŒ–**ï¼šæ–°è¿›ç¨‹æ‰§è¡Œ `ActivityThread.main()`ï¼Œåˆ›å»º `Application` å’Œ `Activity`ã€‚
5. **ç•Œé¢æ˜¾ç¤º**ï¼šAMS é€šè¿‡ Binder è°ƒåº¦ Activity çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼ˆ`onCreate()`ã€`onResume()`ï¼‰ã€‚

---

#### **äº”ã€æŠ€æœ¯äº®ç‚¹**
| **ç»„ä»¶**  | **å…³é”®æŠ€æœ¯**                                                                 | **ä¼˜åŒ–ç›®çš„**                     |
|-----------|-----------------------------------------------------------------------------|--------------------------------|
| **Zygote** | - Copy-on-Write è¿›ç¨‹å¤ç”¨<br>- é¢„åŠ è½½å…¬å…±èµ„æº                                  | å‡å°‘å†…å­˜å ç”¨ï¼ŒåŠ é€Ÿåº”ç”¨å¯åŠ¨          |
| **AMS**    | - Binder IPC è·¨è¿›ç¨‹é€šä¿¡<br>- è¿›ç¨‹ä¼˜å…ˆçº§ç®¡ç†ï¼ˆOOM_ADJï¼‰                       | ç»Ÿä¸€è°ƒåº¦ç³»ç»Ÿèµ„æºï¼Œä¿è¯æµç•…æ€§         |

---

#### **å…­ã€å¸¸è§é—®é¢˜è§£æ**
**Q1: ä¸ºä»€ä¹ˆéœ€è¦ Zygote è€Œä¸æ˜¯ç›´æ¥ fork æ–°è¿›ç¨‹ï¼Ÿ**  
- **èµ„æºå…±äº«**ï¼šé¢„åŠ è½½çš„ç±»åº“å’Œèµ„æºå¯è¢«æ‰€æœ‰åº”ç”¨è¿›ç¨‹å…±äº«ï¼Œå‡å°‘å†…å­˜å†—ä½™ã€‚
- **å¯åŠ¨é€Ÿåº¦**ï¼šCOW æœºåˆ¶æ¯”å®Œæ•´åˆ›å»ºè¿›ç¨‹å¿« 10 å€ä»¥ä¸Šã€‚

**Q2: AMS å¦‚ä½•é˜²æ­¢æ¶æ„åº”ç”¨æ— é™åˆ›å»ºè¿›ç¨‹ï¼Ÿ**  
- **è¿›ç¨‹æ•°é™åˆ¶**ï¼šé€šè¿‡ `max_phantom_processes` æ§åˆ¶åƒµå°¸è¿›ç¨‹æ•°é‡ã€‚
- **LRU æ·˜æ±°**ï¼šå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼ŒAMS æŒ‰ä¼˜å…ˆçº§å›æ”¶æ—§è¿›ç¨‹ã€‚

**Q3: SystemServer å’Œ Zygote çš„å…³ç³»ï¼Ÿ**  
- **çˆ¶å­è¿›ç¨‹**ï¼šSystemServer æ˜¯ Zygote fork çš„ç¬¬ä¸€ä¸ª Java è¿›ç¨‹ã€‚
- **åˆ†å·¥æ˜ç¡®**ï¼šZygote è´Ÿè´£â€œç”Ÿå­©å­â€ï¼ŒSystemServer è´Ÿè´£â€œç®¡å®¶åŠ¡â€ï¼ˆAMS/PMS/WMS ç­‰æ ¸å¿ƒæœåŠ¡ï¼‰ã€‚

---

#### **ä¸ƒã€å¯åŠ¨è€—æ—¶ä¼˜åŒ–**
1. **Zygote é¢„åŠ è½½ä¼˜åŒ–**ï¼š
   ```bash
   # ä¿®æ”¹é¢„åŠ è½½åˆ—è¡¨ï¼ˆå‡å°‘ä¸å¿…è¦çš„ç±»ï¼‰
   /system/etc/preloaded-classes
   ```
2. **AMS è¿›ç¨‹è°ƒåº¦ä¼˜åŒ–**ï¼š
   ```java
   // è®¾ç½®åå°è¿›ç¨‹é™åˆ¶
   ActivityManager.setProcessLimit(4);
   ```

---

#### **å…«ã€æ€»ç»“**
- **Zygote**ï¼šAndroid çš„â€œè¿›ç¨‹å­µåŒ–å™¨â€ï¼Œé€šè¿‡ COW å®ç°é«˜æ•ˆè¿›ç¨‹åˆ›å»ºã€‚
- **AMS**ï¼šç³»ç»Ÿçš„â€œå¤§ç®¡å®¶â€ï¼Œç»Ÿä¸€ç®¡ç†å››å¤§ç»„ä»¶å’Œè¿›ç¨‹ç”Ÿå‘½å‘¨æœŸã€‚
- **åä½œå…³é”®**ï¼šåŸºäº Socket çš„è¿›ç¨‹åˆ›å»ºè¯·æ±‚ + Binder çš„è·¨è¿›ç¨‹æ§åˆ¶ã€‚

ç†è§£ AMS å’Œ Zygote çš„åä½œæœºåˆ¶ï¼Œæ˜¯æŒæ¡ Android ç³»ç»Ÿåº•å±‚åŸç†çš„é‡è¦åŸºçŸ³ã€‚



### **Android App å¯åŠ¨æµç¨‹è¯¦è§£**

Android åº”ç”¨çš„å¯åŠ¨æµç¨‹æ¶‰åŠå¤šä¸ªç³»ç»Ÿç»„ä»¶å’Œé˜¶æ®µï¼Œä»ç”¨æˆ·ç‚¹å‡»å›¾æ ‡åˆ°ç•Œé¢æ˜¾ç¤ºï¼Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªå…³é”®æ­¥éª¤ï¼š

---

## **1. ç”¨æˆ·ç‚¹å‡» App å›¾æ ‡**
- è§¦å‘ `Launcher`ï¼ˆæ¡Œé¢åº”ç”¨ï¼‰å‘ `ActivityManagerService`ï¼ˆAMSï¼‰å‘é€å¯åŠ¨è¯·æ±‚ã€‚
- AMS æ£€æŸ¥åº”ç”¨è¿›ç¨‹æ˜¯å¦å­˜åœ¨ï¼š
  - **å¦‚æœè¿›ç¨‹ä¸å­˜åœ¨**ï¼šåˆ›å»ºæ–°è¿›ç¨‹ã€‚
  - **å¦‚æœè¿›ç¨‹å·²å­˜åœ¨**ï¼šç›´æ¥å”¤é†’ç›®æ ‡ Activityã€‚

---

## **2. åˆ›å»ºåº”ç”¨è¿›ç¨‹ï¼ˆZygote å­µåŒ–ï¼‰**
- **AMS é€šè¿‡ Socket é€šçŸ¥ `Zygote` è¿›ç¨‹**ï¼ˆAndroid çš„è¿›ç¨‹å­µåŒ–å™¨ï¼‰`fork()` ä¸€ä¸ªæ–°è¿›ç¨‹ã€‚
- **æ–°è¿›ç¨‹çš„å…¥å£æ˜¯ `ActivityThread.main()`**ï¼Œè¿™é‡Œæ˜¯åº”ç”¨çš„â€œä¸»çº¿ç¨‹â€ï¼ˆUI çº¿ç¨‹ï¼‰ã€‚
- åˆå§‹åŒ– `Application` å’Œä¸»çº¿ç¨‹çš„ `Looper`ï¼ˆæ¶ˆæ¯å¾ªç¯ï¼‰ã€‚

---

## **3. åˆå§‹åŒ– Application**
- **è°ƒç”¨ `Application.onCreate()`**ï¼š
  - è¿™æ˜¯åº”ç”¨çº§åˆ«çš„åˆå§‹åŒ–å…¥å£ã€‚
  - é€šå¸¸åœ¨è¿™é‡Œåˆå§‹åŒ–å…¨å±€ç»„ä»¶ï¼ˆå¦‚æ•°æ®åº“ã€ç½‘ç»œåº“ã€Crash ç›‘æ§ç­‰ï¼‰ã€‚
- **ç»‘å®š `ContentProvider`**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
  - `ContentProvider` çš„ `onCreate()` ä¼šåœ¨ `Application.onCreate()` **ä¹‹å‰**è°ƒç”¨ã€‚

---

## **4. å¯åŠ¨å…¥å£ Activity**
- **AMS é€šè¿‡ Binder é€šçŸ¥ `ActivityThread` åˆ›å»ºç›®æ ‡ Activity**ã€‚
- **æ‰§è¡Œ Activity çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•**ï¼š
  1. **`Activity` å®ä¾‹åŒ–**ï¼ˆè°ƒç”¨æ„é€ å‡½æ•°ï¼‰ã€‚
  2. **`attach()`**ï¼šç»‘å®š `Context` å’Œ `Window`ã€‚
  3. **`onCreate()`**ï¼š
     - è°ƒç”¨ `setContentView()` åŠ è½½å¸ƒå±€ã€‚
     - åˆå§‹åŒ– UI å’Œæ•°æ®ã€‚
  4. **`onStart()`**ï¼šActivity å¯è§ä½†æœªè¿›å…¥å‰å°ã€‚
  5. **`onResume()`**ï¼šActivity è¿›å…¥å‰å°ï¼Œå¯äº¤äº’ã€‚

---

## **5. UI æ¸²æŸ“æµç¨‹**
- **`ViewRootImpl` æ¥ç®¡ UI æ¸²æŸ“**ï¼š
  - `Activity` çš„ `Window` å…³è” `ViewRootImpl`ã€‚
  - **`performTraversals()`** è§¦å‘ `measure` â†’ `layout` â†’ `draw`ï¼š
    1. **Measure**ï¼šè®¡ç®— View çš„å¤§å°ã€‚
    2. **Layout**ï¼šç¡®å®š View çš„ä½ç½®ã€‚
    3. **Draw**ï¼šç»˜åˆ¶åˆ°å±å¹•ï¼ˆé€šè¿‡ `SurfaceFlinger` æäº¤ç»™ GPUï¼‰ã€‚

---

## **6. æœ€ç»ˆæ˜¾ç¤º**
- **`SurfaceFlinger` åˆæˆå›¾å±‚**ï¼Œé€šè¿‡ `HWComposer` æˆ– `GPU` æ¸²æŸ“åˆ°å±å¹•ã€‚
- ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„ App ç•Œé¢ã€‚

---

## **æµç¨‹å›¾**
```mermaid
sequenceDiagram
    participant Launcher
    participant AMS
    participant Zygote
    participant ActivityThread
    participant Application
    participant Activity

    Launcher->>AMS: startActivity(intent)
    AMS->>Zygote: fork() æ–°è¿›ç¨‹
    Zygote->>ActivityThread: main()
    ActivityThread->>Application: onCreate()
    ActivityThread->>Activity: attach()
    Activity->>Activity: onCreate()
    Activity->>Activity: onStart()
    Activity->>Activity: onResume()
    Activity->>ViewRootImpl: performTraversals()
    ViewRootImpl->>SurfaceFlinger: æäº¤å¸§æ•°æ®
    SurfaceFlinger->>Screen: æ˜¾ç¤ºç•Œé¢
```

---

## **å…³é”®ç‚¹æ€»ç»“**
1. **è¿›ç¨‹åˆ›å»º**ï¼šç”± `Zygote` `fork()` å‡ºåº”ç”¨è¿›ç¨‹ï¼Œå…¥å£æ˜¯ `ActivityThread.main()`ã€‚
2. **Application åˆå§‹åŒ–**ï¼š`Application.onCreate()` æ˜¯æœ€æ—©çš„å›è°ƒï¼Œé€‚åˆå…¨å±€åˆå§‹åŒ–ã€‚
3. **Activity å¯åŠ¨**ï¼š`onCreate()` â†’ `onStart()` â†’ `onResume()`ã€‚
4. **UI æ¸²æŸ“**ï¼š`ViewRootImpl` è´Ÿè´£ `measure/layout/draw`ï¼Œæœ€ç»ˆç”± `SurfaceFlinger` æ˜¾ç¤ºã€‚
5. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - å‡å°‘ `Application.onCreate()` çš„è€—æ—¶ï¼ˆé¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼‰ã€‚
   - ä¼˜åŒ– `Activity` çš„ `onCreate()`ï¼ˆå»¶è¿ŸåŠ è½½ã€å¼‚æ­¥åŠ è½½æ•°æ®ï¼‰ã€‚

---

## **å¸¸è§é—®é¢˜**
### **Q1ï¼šå†·å¯åŠ¨ vs çƒ­å¯åŠ¨**
- **å†·å¯åŠ¨**ï¼šè¿›ç¨‹ä¸å­˜åœ¨ï¼Œå®Œæ•´èµ°ä¸Šè¿°æµç¨‹ï¼ˆæœ€æ…¢ï¼‰ã€‚
- **çƒ­å¯åŠ¨**ï¼šè¿›ç¨‹å·²å­˜åœ¨ï¼Œç›´æ¥å”¤é†’ Activityï¼ˆè·³è¿‡ `Application` åˆå§‹åŒ–ï¼‰ã€‚

### **Q2ï¼šå¦‚ä½•ä¼˜åŒ–å¯åŠ¨é€Ÿåº¦ï¼Ÿ**
- å‡å°‘ `Application` åˆå§‹åŒ–ä»»åŠ¡ï¼ˆä½¿ç”¨æ‡’åŠ è½½æˆ–å¼‚æ­¥åˆå§‹åŒ–ï¼‰ã€‚
- ä½¿ç”¨ `SplashScreen` APIï¼ˆAndroid 12+ï¼‰é¿å…ç™½å±ã€‚
- é¿å…ä¸»çº¿ç¨‹ I/O æ“ä½œï¼ˆå¦‚æ•°æ®åº“åˆå§‹åŒ–ï¼‰ã€‚

### **Q3ï¼š`ContentProvider` ä¸ºä»€ä¹ˆåœ¨ `Application.onCreate()` ä¹‹å‰åˆå§‹åŒ–ï¼Ÿ**
- ç³»ç»Ÿä¼šåœ¨ `Application` åˆå§‹åŒ–å‰åŠ è½½ `<application>` ä¸­å£°æ˜çš„ `ContentProvider`ï¼Œä»¥ä¾¿å…¶ä»–åº”ç”¨èƒ½å°½æ—©è®¿é—®æ•°æ®ã€‚

---

æŒæ¡è¿™äº›æµç¨‹åï¼Œå¯ä»¥æ›´é«˜æ•ˆåœ°ä¼˜åŒ– App å¯åŠ¨æ€§èƒ½ï¼ ğŸš€