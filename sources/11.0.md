# ART虚拟机与Dalvik虚拟机的区别

Android运行时(ART)和Dalvik是Android系统使用的两种不同的虚拟机技术，它们在性能、执行方式和系统效率等方面有显著差异。

## 一、核心区别对比

| 特性                | Dalvik虚拟机                       | ART虚拟机                          |
|---------------------|-----------------------------------|-----------------------------------|
| **引入时间**         | Android 1.0 (2008年)              | Android 4.4(可选), 5.0(默认)(2014年) |
| **编译时机**         | 安装时仅验证，运行时即时编译(JIT)    | 安装时完全编译(AOT)                 |
| **执行方式**         | 解释执行+JIT热点代码编译            | 直接执行预编译的本地机器码           |
| **启动速度**         | 较慢(需要运行时编译)                | 较快(直接执行本地代码)               |
| **存储空间占用**     | 较小(只存DEX)                      | 较大(存储OAT/ELF文件)               |
| **内存占用**         | 较高(需要维护JIT编译器)             | 较低(无运行时编译开销)               |
| **电池效率**         | 较低(持续编译消耗CPU)               | 较高(减少CPU计算)                   |
| **安装时间**         | 较短(仅验证)                       | 较长(需要预编译)                     |
| **兼容性**           | 支持所有Android版本                | 需要Android 4.4+                   |

## 二、技术细节差异

### 1. 编译方式

**Dalvik**:
- 使用JIT(Just-In-Time)编译
- 运行时动态将DEX字节码编译为机器码
- 只对热点代码进行编译优化

```java
// Dalvik执行流程
DEX字节码 → Dalvik JIT编译器 → 机器码 → CPU执行
```

**ART**:
- 使用AOT(Ahead-Of-Time)编译
- 安装时就将所有DEX字节码编译为本地机器码
- 生成OAT/ELF格式的可执行文件

```java
// ART执行流程
APK安装时: DEX字节码 → dex2oat工具 → OAT/ELF文件
运行时: 直接执行OAT/ELF本地代码
```

### 2. 内存管理

**Dalvik**:
- 使用标记-清除(Mark-Sweep)垃圾回收
- GC时会暂停所有线程(STW问题)
- 内存碎片化较严重

**ART**:
- 改进的并发垃圾回收
- 减少GC停顿时间
- 支持并行化处理
- 内存分配策略更高效

### 3. 64位支持

**Dalvik**:
- 仅支持32位
- 无法充分利用64位CPU优势

**ART**:
- 原生支持64位(ARM64/x86_64)
- 更好的大内存应用支持
- 兼容32/64位混合模式

## 三、性能对比

1. **应用启动速度**:
   - ART比Dalvik快约20-30%
   - 特别是冷启动时差异更明显

2. **CPU利用率**:
   - ART可降低10-20%的CPU使用率
   - 减少电池消耗

3. **内存占用**:
   - ART运行时内存减少约10%
   - 但存储空间占用增加10-20%

4. **长时间运行**:
   - ART性能更稳定
   - Dalvik可能因JIT编译波动

## 四、开发者影响

1. **编译产物**:
   - Dalvik: `.dex`文件
   - ART: `.oat`或`.elf`文件(存储在`/data/dalvik-cache/`)

2. **调试差异**:
   - ART提供更准确的堆栈跟踪
   - JIT编译的代码可能难以调试

3. **兼容性考虑**:
   ```xml
   <!-- AndroidManifest.xml中可指定虚拟机 -->
   <application android:vmSafeMode="true">  <!-- 强制使用Dalvik -->
   ```

4. **NDK开发**:
   - ART对Native代码支持更好
   - 更严格的JNI检查

## 五、演进历史

1. **Dalvik时期** (2008-2014):
   - 专为移动设备设计
   - 基于寄存器架构(不同于JVM的栈架构)
   - 使用DEX格式减少体积

2. **过渡期** (Android 4.4 KitKat):
   - 同时包含Dalvik和ART
   - 开发者可选启用ART

3. **ART时代** (Android 5.0+):
   - 完全取代Dalvik
   - 持续优化AOT编译
   - Android 7.0引入混合编译(JIT+AOT)
   - Android 10改进Profile-Guided优化

## 六、为什么ART取代Dalvik

1. **性能需求**:
   - 应用越来越复杂
   - 用户对流畅度要求提高

2. **硬件发展**:
   - 设备存储容量增大
   - 多核CPU普及

3. **能效比**:
   - 移动设备对电池续航敏感
   - AOT减少运行时计算

4. **64位支持**:
   - 适应64位CPU时代

ART的设计更符合现代Android系统的需求，虽然牺牲了一些安装时间和存储空间，但换来了更好的运行时性能和用户体验。