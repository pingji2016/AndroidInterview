# **ContentProvider çš„å®ç°åŸç†è¯¦è§£**

`ContentProvider` æ˜¯ Android å››å¤§ç»„ä»¶ä¹‹ä¸€ï¼Œä¸»è¦ç”¨äº **è·¨åº”ç”¨æ•°æ®å…±äº«**ï¼Œæä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£ï¼ˆå¦‚è”ç³»äººã€åª’ä½“åº“ç­‰ç³»ç»Ÿæ•°æ®ï¼‰ã€‚å®ƒçš„æ ¸å¿ƒåŸç†æ¶‰åŠ **Binder é€šä¿¡ã€URI æœºåˆ¶ã€æƒé™æ§åˆ¶** ç­‰ã€‚ä¸‹é¢ä» **å·¥ä½œåŸç†ã€å®ç°æ­¥éª¤ã€åº•å±‚æœºåˆ¶** è¯¦ç»†è§£æã€‚

---

## **ğŸ“Œ 1. ContentProvider çš„æ ¸å¿ƒä½œç”¨**
- **æ•°æ®æŠ½è±¡å±‚**ï¼šå°è£…æ•°æ®æºï¼ˆSQLiteã€æ–‡ä»¶ã€ç½‘ç»œç­‰ï¼‰ï¼Œå¯¹å¤–æä¾›ç»Ÿä¸€çš„ CRUD æ¥å£ã€‚
- **è·¨è¿›ç¨‹å…±äº«**ï¼šé€šè¿‡ Binder è®©å…¶ä»–åº”ç”¨å®‰å…¨è®¿é—®æ•°æ®ã€‚
- **æƒé™æ§åˆ¶**ï¼šé€šè¿‡ `AndroidManifest.xml` å£°æ˜è¯»å†™æƒé™ã€‚

---

## **ğŸ“Œ 2. ContentProvider çš„å·¥ä½œåŸç†**
### **ï¼ˆ1ï¼‰åŸºäº Binder çš„è·¨è¿›ç¨‹é€šä¿¡**
- **Provider è¿›ç¨‹**ï¼šå®é™…æŒæœ‰æ•°æ®ï¼ˆå¦‚ç³»ç»Ÿè”ç³»äºº Providerï¼‰ã€‚
- **Client è¿›ç¨‹**ï¼šé€šè¿‡ `ContentResolver` è®¿é—® Providerã€‚
- **é€šä¿¡æµç¨‹**ï¼š
  ```mermaid
    +-------------------+       +-------------------+       +-------------------+
    |   Client App      |       |  ContentResolver  |       |  ContentProvider  |
    |                   |       |                   |       |  (å¯èƒ½åœ¨å…¶ä»–è¿›ç¨‹) |
    | 1. getContent-    | ----> | 2. æ ¹æ® URI å®šä½   | ----> | 3. Binder IPC      |
    |    Resolver()     |       |   ç›®æ ‡ Provider    |       |   è°ƒç”¨ query()     |
    |                   |       |                   |       |                   |
    +-------------------+       +-------------------+       +-------------------+
  ```

### **ï¼ˆ2ï¼‰URIï¼ˆUniform Resource Identifierï¼‰æœºåˆ¶**
- æ¯ä¸ª Provider é€šè¿‡ **å”¯ä¸€ URI** æ ‡è¯†ï¼Œæ ¼å¼ç¤ºä¾‹ï¼š
  ```java
  content://com.example.provider/user/1
  ```
  - `content://`ï¼šåè®®å¤´ï¼Œæ ‡è¯† ContentProviderã€‚
  - `com.example.provider`ï¼šProvider çš„ `authority`ï¼ˆéœ€åœ¨ Manifest å£°æ˜ï¼‰ã€‚
  - `user`ï¼šæ•°æ®è¡¨åã€‚
  - `1`ï¼šè®°å½•çš„ IDã€‚

### **ï¼ˆ3ï¼‰æŸ¥è¯¢æµç¨‹ï¼ˆä»¥ query() ä¸ºä¾‹ï¼‰**
1. **Client è°ƒç”¨**ï¼š
   ```java
   Cursor cursor = getContentResolver().query(
       Uri.parse("content://com.example.provider/user"),
       null, null, null, null
   );
   ```
2. **ç³»ç»Ÿé€šè¿‡ URI æ‰¾åˆ°å¯¹åº”çš„ ContentProvider**ã€‚
3. **Provider çš„ query() æ–¹æ³•è¢«è°ƒç”¨**ï¼Œè¿”å› `Cursor` å¯¹è±¡ã€‚
4. **Cursor é€šè¿‡ Binder è·¨è¿›ç¨‹è¿”å›ç»™ Client**ã€‚

---

## **ğŸ“Œ 3. å®ç°ä¸€ä¸ª ContentProvider çš„æ­¥éª¤**
### **ï¼ˆ1ï¼‰å®šä¹‰ Contract ç±»ï¼ˆçº¦å®š URI å’Œåˆ—åï¼‰**
```java
public final class UserContract {
    public static final String AUTHORITY = "com.example.provider";
    public static final Uri CONTENT_URI = Uri.parse("content://" + AUTHORITY + "/user");

    public static class User {
        public static final String _ID = "_id";
        public static final String NAME = "name";
    }
}
```

### **ï¼ˆ2ï¼‰ç»§æ‰¿ ContentProvider å¹¶é‡å†™æ–¹æ³•**
```java
public class UserProvider extends ContentProvider {
    private SQLiteDatabase db;

    @Override
    public boolean onCreate() {
        // åˆå§‹åŒ–æ•°æ®åº“
        db = new DatabaseHelper(getContext()).getWritableDatabase();
        return true;
    }

    @Override
    public Cursor query(Uri uri, String[] projection, String selection,
                       String[] selectionArgs, String sortOrder) {
        // æŸ¥è¯¢æ•°æ®åº“å¹¶è¿”å› Cursor
        return db.query("user", projection, selection, selectionArgs, null, null, sortOrder);
    }

    @Override
    public Uri insert(Uri uri, ContentValues values) {
        long id = db.insert("user", null, values);
        return ContentUris.withAppendedId(uri, id);
    }

    // å…¶ä»–æ–¹æ³•ï¼šupdate(), delete(), getType()
}
```

### **ï¼ˆ3ï¼‰åœ¨ AndroidManifest.xml ä¸­å£°æ˜**
```xml
<provider
    android:name=".UserProvider"
    android:authorities="com.example.provider"
    android:exported="true"  <!-- æ˜¯å¦å…è®¸å…¶ä»–åº”ç”¨è®¿é—® -->
    android:readPermission="com.example.READ_USER"  <!-- å¯é€‰æƒé™æ§åˆ¶ -->
    android:writePermission="com.example.WRITE_USER" />
```

---

## **ğŸ“Œ 4. åº•å±‚æœºåˆ¶è§£æ**
### **ï¼ˆ1ï¼‰Binder é©±åŠ¨è·¨è¿›ç¨‹é€šä¿¡**
- **ContentProvider çš„ Binder å¯¹è±¡**ï¼šç”± `ActivityThread` åœ¨ Provider è¿›ç¨‹åˆ›å»ºã€‚
- **Client è®¿é—®æµç¨‹**ï¼š
  1. Client è°ƒç”¨ `ContentResolver.query()`ã€‚
  2. ç³»ç»Ÿé€šè¿‡ `ServiceManager` æŸ¥æ‰¾å¯¹åº”çš„ `ContentProvider` Binder å¯¹è±¡ã€‚
  3. è°ƒç”¨ `ContentProviderNative` çš„è·¨è¿›ç¨‹æ–¹æ³•ã€‚

### **ï¼ˆ2ï¼‰URI åŒ¹é…ä¸æƒé™éªŒè¯**
- **URI åŒ¹é…**ï¼šé€šè¿‡ `UriMatcher` è§£æ URI è·¯å¾„ï¼š
  ```java
  private static final UriMatcher uriMatcher = new UriMatcher(UriMatcher.NO_MATCH);
  static {
      uriMatcher.addURI(UserContract.AUTHORITY, "user", USER_DIR);
      uriMatcher.addURI(UserContract.AUTHORITY, "user/#", USER_ITEM);
  }
  ```
- **æƒé™æ£€æŸ¥**ï¼šç³»ç»Ÿåœ¨è°ƒç”¨ `query()/insert()` å‰ä¼šæ£€æŸ¥ Manifest å£°æ˜çš„ `readPermission/writePermission`ã€‚

### **ï¼ˆ3ï¼‰Cursor çš„è·¨è¿›ç¨‹å°è£…**
- **CursorWindow**ï¼šå®é™…æ•°æ®å­˜å‚¨åœ¨å…±äº«å†…å­˜ä¸­ï¼Œé€šè¿‡ Binder ä¼ é€’ã€‚
- **Client ç«¯çš„ Cursor** æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆ`CursorWrapperInner`ï¼‰ï¼Œé€šè¿‡ IPC è¯»å–æ•°æ®ã€‚

---

## **ğŸ“Œ 5. æ€§èƒ½ä¼˜åŒ–ä¸æ³¨æ„äº‹é¡¹**
### **ï¼ˆ1ï¼‰é¿å…ä¸»çº¿ç¨‹è®¿é—®**
- **ContentProvider çš„ CRUD æ“ä½œå¯èƒ½é˜»å¡ä¸»çº¿ç¨‹**ï¼Œå»ºè®®ç”¨ `CursorLoader`ï¼ˆå·²åºŸå¼ƒï¼‰æˆ– `Room + LiveData` æ›¿ä»£ã€‚

### **ï¼ˆ2ï¼‰æ‰¹é‡æ“ä½œï¼ˆapplyBatchï¼‰**
```java
ArrayList<ContentProviderOperation> ops = new ArrayList<>();
ops.add(ContentProviderOperation.newInsert(uri).withValues(values).build());
getContentResolver().applyBatch(AUTHORITY, ops);
```

### **ï¼ˆ3ï¼‰é˜²æ­¢ SQL æ³¨å…¥**
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼š
  ```java
  db.query("user", null, "name=?", new String[]{userInput}, null, null, null);
  ```

### **ï¼ˆ4ï¼‰Android 11+ çš„åŒ…å¯è§æ€§é™åˆ¶**
- å¦‚æœ Provider åªä¾›æœ¬åº”ç”¨ä½¿ç”¨ï¼Œè®¾ç½® `android:exported="false"`ã€‚

---

## **ğŸ“Œ 6. ä¸å…¶ä»–æ–¹æ¡ˆçš„å¯¹æ¯”**
| **æ–¹æ¡ˆ**            | **é€‚ç”¨åœºæ™¯**                     | **è·¨è¿›ç¨‹** | **æƒé™æ§åˆ¶** |
|---------------------|--------------------------------|-----------|-------------|
| **ContentProvider** | ç»“æ„åŒ–æ•°æ®å…±äº«ï¼ˆå¦‚è”ç³»äººã€åª’ä½“åº“ï¼‰ | âœ…         | âœ…           |
| **FileProvider**    | å®‰å…¨å…±äº«æ–‡ä»¶                    | âœ…         | âœ…           |
| **Broadcast**       | ç®€å•äº‹ä»¶é€šçŸ¥                    | âœ…         | âŒ           |
| **AIDL**            | å¤æ‚è·¨è¿›ç¨‹æ¥å£                  | âœ…         | âœ…           |

---

## **ğŸ“Œ 7. æ€»ç»“**
1. **æ ¸å¿ƒåŸç†**ï¼šåŸºäº Binder çš„è·¨è¿›ç¨‹é€šä¿¡ + URI è·¯ç”± + æƒé™æ§åˆ¶ã€‚
2. **å®ç°æ­¥éª¤**ï¼š
   - å®šä¹‰ Contract ç±»ï¼ˆURI å’Œåˆ—åï¼‰ã€‚
   - ç»§æ‰¿ `ContentProvider`ï¼Œé‡å†™ CRUD æ–¹æ³•ã€‚
   - åœ¨ Manifest ä¸­å£°æ˜ Provider å’Œæƒé™ã€‚
3. **ä¼˜åŒ–å»ºè®®**ï¼šé¿å…ä¸»çº¿ç¨‹æ“ä½œã€ä½¿ç”¨æ‰¹é‡æ›´æ–°ã€é˜²æ­¢ SQL æ³¨å…¥ã€‚
4. **é€‚ç”¨åœºæ™¯**ï¼šè·¨åº”ç”¨å…±äº«ç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚è‡ªå®šä¹‰æ•°æ®åº“ã€æ–‡ä»¶å…ƒä¿¡æ¯ï¼‰ã€‚

é€šè¿‡ `ContentProvider`ï¼ŒAndroid å®ç°äº†å®‰å…¨ã€æ ‡å‡†åŒ–çš„æ•°æ®å…±äº«æœºåˆ¶ï¼Œä½†ç°ä»£å¼€å‘ä¸­æ›´æ¨è **Room + LiveData** æˆ– **WorkManager** æ›¿ä»£éƒ¨åˆ†åœºæ™¯ã€‚